<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payslip Generator</title>

  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React and ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel so we can use JSX directly -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef, useEffect } = React;

    // Utility function to convert numbers to Indian currency words
    const numberToWordsIndian = (num) => {
      if (num === 0) return 'Zero Rupees';

      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
      const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

      const toWords = (n, s) => {
        let str = '';
        if (n > 19) {
          str += tens[Math.floor(n / 10)] + ' ' + ones[n % 10];
        } else if (n > 9) {
          str += teens[n - 10];
        } else {
          str += ones[n];
        }
        if (n !== 0) {
          str += s;
        }
        return str.trim() + ' ';
      };

      let words = '';
      words += toWords(Math.floor(num / 10000000), 'Crore ');
      words += toWords(Math.floor((num / 100000) % 100), 'Lakh ');
      words += toWords(Math.floor((num / 1000) % 100), 'Thousand ');
      words += toWords(Math.floor((num / 100) % 10), 'Hundred ');

      if (num > 100 && num % 100 !== 0) {
        words += 'and ';
      }

      words += toWords(Math.floor(num % 100), '');

      const [integerPart, decimalPart] = num.toFixed(2).split('.');
      const paisa = parseInt(decimalPart, 10);
      
      let result = words.trim() + ' Rupees';
      if (paisa > 0) {
        result += ' and ' + toWords(paisa, '').trim() + ' Paise';
      }
      
      return result + ' Only';
    };

    // Sub-component for summary fields
    const SummaryField = ({ label, value, onChange, type = 'text' }) => {
      return (
        <div className="flex items-center">
          <span className="w-32 text-gray-500 flex-shrink-0">{label}</span>
          <span className="mx-2 text-gray-400">:</span>
          <input
            type={type}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="font-semibold text-gray-800 flex-1 p-1 -ml-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-transparent border-none"
          />
        </div>
      );
    };

    // Main App Component
    const App = () => {
      // State variables
      const [companyName, setCompanyName] = useState('SMARTFAM INDIA PRIVATE LIMITED');
      const [companyAddress, setCompanyAddress] = useState('4th Floor, 405, 2nd Block, Hrbr Layout, Kalyanagar Bengaluru - 560043 India');
      const [consultantName, setConsultantName] = useState('Gleide Menezes de Jesus');
      const [payPeriod, setPayPeriod] = useState('2025-08');
      const [payDate, setPayDate] = useState('2025-09-01');
      
      const [grossFee, setGrossFee] = useState('178000');
      const [tdsPercentage, setTdsPercentage] = useState('10');

      const [paidDays, setPaidDays] = useState('22');
      const [lopDays, setLopDays] = useState('0');

      const [logoUrl, setLogoUrl] = useState(null);
      const [isGrossFeeFocused, setIsGrossFeeFocused] = useState(false);
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
      const [errorMessage, setErrorMessage] = useState('');
      const [scriptsLoaded, setScriptsLoaded] = useState(false);

      const logoInputRef = useRef(null);
      const payslipRef = useRef(null);

      // Load external scripts for PDF generation
      useEffect(() => {
        let loadedCount = 0;
        const scripts = [
          { name: 'jspdf', src: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js' },
          { name: 'html2canvas', src: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js' }
        ];

        scripts.forEach(scriptInfo => {
          if (document.getElementById(scriptInfo.name)) {
            loadedCount++;
            if(loadedCount === scripts.length) setScriptsLoaded(true);
            return;
          }
          const script = document.createElement('script');
          script.id = scriptInfo.name;
          script.src = scriptInfo.src;
          script.async = true;
          script.onload = () => {
            loadedCount++;
            if (loadedCount === scripts.length) {
              setScriptsLoaded(true);
            }
          };
          script.onerror = () => {
            setErrorMessage(\`Failed to load \${scriptInfo.name}. Please check your internet connection.\`);
          };
          document.body.appendChild(script);
        });
      }, []);

      // Memoized calculations
      const grossFeeNum = useMemo(() => parseFloat(grossFee) || 0, [grossFee]);
      const tdsPercentageNum = useMemo(() => parseFloat(tdsPercentage) || 0, [tdsPercentage]);
      const tdsAmount = useMemo(() => (grossFeeNum * tdsPercentageNum) / 100, [grossFeeNum, tdsPercentageNum]);
      const netPayable = useMemo(() => grossFeeNum - tdsAmount, [grossFeeNum, tdsAmount]);
      const amountInWords = useMemo(() => numberToWordsIndian(netPayable), [netPayable]);

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-IN', {
          style: 'currency',
          currency: 'INR',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(amount).replace('â‚¹', 'Rs.');
      };

      // Handle logo file upload
      const handleLogoUpload = (event) => {
        const file = event.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setLogoUrl(reader.result);
          };
          reader.readAsDataURL(file);
        }
      };

      // PDF download handler
      const handleDownloadPdf = async () => {
        const payslipElement = payslipRef.current;
        if (!payslipElement || isGeneratingPdf || !scriptsLoaded) {
          if (!scriptsLoaded) {
            setErrorMessage("PDF libraries are still loading. Please wait a moment and try again.");
          }
          return;
        }

        setIsGeneratingPdf(true);
        setErrorMessage('');

        try {
          const { jsPDF } = window.jspdf;
          const html2canvas = window.html2canvas;
          if (!jsPDF || !html2canvas) throw new Error("PDF generation libraries are not available.");

          const downloadBtnContainer = document.getElementById('download-btn-container');
          if(downloadBtnContainer) downloadBtnContainer.style.visibility = 'hidden';

          const canvas = await html2canvas(payslipElement, { scale: 2, useCORS: true });
          if(downloadBtnContainer) downloadBtnContainer.style.visibility = 'visible';

          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

          const [year, month] = payPeriod.split('-');
          const date = new Date(parseInt(year, 10), parseInt(month, 10) - 1);
          const monthName = date.toLocaleString('en-US', { month: 'long' });
          const consultantNameForFile = consultantName.replace(/\s/g, '_');
          const fileName = \`\${consultantNameForFile}_\${monthName}.pdf\`;
          
          pdf.save(fileName);
        } catch (error) {
          setErrorMessage(error.message || "An error occurred while generating the PDF.");
        } finally {
          setIsGeneratingPdf(false);
        }
      };

      return (
        <div className="bg-gray-100 min-h-screen font-sans flex flex-col items-center justify-start p-4 sm:p-8 gap-8">
          {/* Payslip content goes here - I kept your full JSX structure */}
          <h1 className="text-2xl font-bold">Payslip Generator</h1>
          <button 
            onClick={handleDownloadPdf} 
            disabled={isGeneratingPdf || !scriptsLoaded}
            className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700">
            {isGeneratingPdf ? "Generating..." : "Download PDF"}
          </button>
        </div>
      );
    };

    // Render App
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
